{% include 'InterfaceTest/head.html' %}
<!-- Main content starts -->

<style>
</style>
<div class="content">
    <!-- Sidebar -->
    {% include 'InterfaceTest/HTTPMenu.html' %}
    <!-- Main bar -->
    <div class="right_col" role="main" style="min-height: 1657px;">
         <div class="">
            <div class="clearfix"></div>
            <div class="row">
              <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2>{{ text.subPageTitle }}</h2>
                    <ul class="nav navbar-right panel_toolbox">
                      <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                      </li>

                    </ul>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <div  data-parsley-validate class="form-horizontal form-label-left">
                      <div>
                        <h2>基本信息</h2>
                      </div>
                        {% if option != "add" %}
                            {% if option != "copy" %}
                                <div class="form-group" >
                                    <label class="control-label col-md-min-1">接口编号</label>
                                    <div class="col-lg-8">
                                        <input type="text" id="interfaceId" class="form-control col-md-7 col-xs-12" disabled value="">
                                    </div>
                                </div>
                                {% else %}
                            {% endif %}
                        {% endif %}
                      <div class="form-group">
                        <label class="control-label col-md-min-1">接口名称 <span class="required">*</span>
                        </label>
                        <div class="col-lg-8">
                          <input  id="name" placeholder="请输入MOCK的接口名称" type="text"  required="required" class="form-control col-md-7 col-xs-12">
                        </div>
                      </div>
                    <div class="form-group">
                        <label class="control-label col-md-min-1 font-label" for="last-name">接口描述
                        </label>
                        <div class="col-lg-8">
                            <textarea type="text" id="describe" required="required" class="form-control col-md-7 col-xs-12 Fixed-width"
                            placeholder="请输入接口描述"
                            ></textarea>
                        </div>
                      </div>
                        <div class="form-group">
                            <label class="control-label col-md-min-1">{{ groupLevel1 }}</label>
                            <div class="col-lg-2" style="width: 13.5%">
                                <select class="form-control" id="businessLine" onchange="switchModule($(this).val())">
                                    {% for business in businessLine %}
                                        <option value="{{ business.id }}">{{ business.bussinessLineName }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <label class="control-label col-md-min-1" style="width:4.3%;">{{ groupLevel2 }}</label>
                            <div class="col-lg-2" style="width: 13.5%">
                                <select class="form-control" id="modules">
                                </select>
                            </div>
                            <label class="control-label col-md-min-1" style="width:4.3%;">TagKey</label>
                            <div class="col-lg-1" style="padding-right: 0px;padding-left: 0px;width:300px;" >
                                <input type="text" name="tagKey" style="border-radius:0px;height: 34px;resize:none" id="tagKey" class="form-control" placeholder="请输入tag,必须是纯英文或者中划线-" value="common" />
                            </div>
                        </div>

                      <div>
                        <h2>MOCK接口信息</h2>
                      </div>
                         <div class="form-group"  >
                            <div  class="col-lg-8" style="width:74%;">

                                <ul id="interfaceTab" class="nav nav-tabs bar_tabs" style="margin-bottom: 5px">
                                    <li class="active"><a href="#requestBody"  onclick="$('#btnDiv').css('margin-top','0px')" data-toggle="tab">MOCK请求信息</a></li>
                                    <li ><a href="#requestBodySend"  onclick="$('#btnDiv').css('margin-top','0px')" data-toggle="tab">关联接口信息</a></li>
                                    {% if option == "edit" or option == "check" %}
                                        <li ><a href="#requestBodyExecute"  onclick="$('#btnDiv').css('margin-top','0px')" data-toggle="tab">执行契约任务</a></li>
                                    {% endif %}
                                </ul>

                                <div id="interfaceTabContent" class="tab-content">
                                    <div class="tab-pane fade active in" id="requestBody" style="margin-left: 10px;margin-right: 10px">
                                        <div class="form-group">
                                            <div class="col-lg-2" style="width:10%;padding-right: 0px">
                                                <select class="form-control"  id="methodSelect" onchange="changeBodyTab($(this).val())" style="border-top-right-radius:0em;border-bottom-right-radius:0em;">
                                                    <option value="GET">GET</option>
                                                    <option value="POST" selected="">POST</option>
                                                    <option value="PUT">PUT</option>
                                                    <option value="PATCH">PATCH</option>
                                                    <option value="DELETE">DELETE</option>
                                                    <option value="HEAD">HEAD</option>
                                                </select>
                                            </div>
                                            <div class="col-lg-1" style="width:12%;padding-right: 0px;padding-left: 0px" >
                                                <select class="form-control" style="border-radius:0px;" id="URI" >
                                                    {% for u in uri %}
                                                    <option value="{{ u.uriKey }}" title="{{ u.uriKey }}：{{ u.uriDesc }}">{{ u.alias }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-lg-2" style="width:77%;padding-right: 0px;padding-left: 0px" >
                                                <input type="text" name="URL" style="border-radius:0px;height: 38px;resize:none" id="URL" class="form-control" placeholder="请输入接口URL，可以用正则" />
                                            </div>

                                        </div>
                                         <div class="form-group">
                                                <div class="col-lg-12" >
                                                    <ul id="myTab2" class="nav nav-tabs bar_tabs"  style="margin-bottom: 0px;margin-top: 15px;">
                                                        <li><a href="#paramsTab" data-toggle="tab" >PARAMS</a></li>
                                                        <li><a href="#headerTab" data-toggle="tab">HEADER(0)</a></li>
                                                        <li  class="active"><a href="#bodyTab" data-toggle="tab">BODY</a></li>
                                                    </ul>

                                                    <div id="myTabContent2" class="tab-content">
                                                        <div class="tab-pane fade" id="headerTab">
                                                            <div class="form-group">
                                                                <div class="col-lg-12">
                                                                    <table class="table" style="table-layout:fixed;" >
                                                                        <thead>
                                                                            <tr style="color: snow" bgcolor="##2A3F54">
                                                                                <th style="font-weight: bold;width: 20%" >Key</th>
                                                                                 <th style="font-weight: bold">Value（可以用正则）</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody id="headerTbody" >
                                                                            <tr name="headerTr">
                                                                                <td style="padding: 0px"><input class="form-control" onclick="addTableTr($(this).parent().parent().parent());$('[href=\'#headerTab\']').text('HEADER('+($('[name=\'headerTr\']').length-1)+')')" name="headerKey" style="background-color: rgb(183, 186, 189);border-radius:0px;"  /></td>
                                                                                <td style="padding: 0px"><input class="form-control" onclick="addTableTr($(this).parent().parent().parent());$('[href=\'#headerTab\']').text('HEADER('+($('[name=\'headerTr\']').length-1)+')')" name="headerValue" style="background-color: rgb(183, 186, 189);border-radius:0px;width:95%;" />
                                                                                <button class="btn btn-danger" style="float: right; margin-top: -35px; display: none;" onclick="$(this).parent().parent().remove();$('[href=\'#headerTab\']').text('HEADER('+($('[name=\'headerTr\']').length-1)+')')"><i class="fa fa-trash"></i></button></td>
                                                                            </tr>

                                                                        </tbody>
                                                                    </table>
                                                                </div>

                                                            </div>
                                                        </div>
                                                        <div class="tab-pane fade" id="paramsTab">
                                                            <div class="form-group">
                                                                <div class="col-lg-12" >
                                                                    <table class="table" style="table-layout:fixed;">
                                                                        <thead>
                                                                            <tr style="color: snow" bgcolor="#2A3F54">
                                                                                <th style="font-weight: bold;width: 20%" >Key</th>
                                                                                 <th style="font-weight: bold">Value  <button class="btn btn-info" onclick="toggleUrlEncode($(this),'params')" style="float: right;margin-top: -8px;margin-bottom: -8px">原始</button></th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody id="paramsTbody">
                                                                            <tr name="paramsTr">
                                                                                <td style="padding: 0px">
                                                                                    <input class="form-control" onclick="addTableTr($(this).parent().parent().parent())" name="paramsKey" style="background-color: rgb(183, 186, 189);border-radius:0px;"  />
                                                                                </td>
                                                                                <td style="padding: 0px">
                                                                                    <input class="form-control" onclick="addTableTr($(this).parent().parent().parent())" name="paramsValue" style="background-color: rgb(183, 186, 189);border-radius:0px;width:95%;" />
                                                                                    <button class="btn btn-danger" style="display:none;float: right;margin-top: -35px;" onclick="$(this).parent().parent().remove()"><i class="fa fa-trash"></i></button>
                                                                                </td>
                                                                            </tr>
                                                                        </tbody>
                                                                    </table>
                                                                    <div class="col-lg-12" style="display:none;">
                                                                    <button class="btn btn-info" onclick="toggleUrlEncode($(this),'params')" style="float: right;margin-top: 0px;;margin-bottom: 0px">key-value</button>
                                                                    <textarea type="text" class="form-control Fixed-width" name="parameter" id="parameter" placeholder="请输入测试参数，可以用正则"></textarea>
                                                                </div>
                                                                </div>


                                                            </div>
                                                        </div>
                                                        <div class="tab-pane fade active in" id="bodyTab" style="margin-left: 20px;margin-right: 20px">
                                                            <div class="form-group" id="body-raw" style="display:block;">
                                                                <div class="col-lg-12" style="padding-left: 0px;padding-right: 0px;">
                                                                    <textarea type="text"  name="body-raw-input" class="form-control Fixed-width" id="body-raw-input" placeholder="请输入请求体，可以用正则"></textarea>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                            </div>
                                    </div>

                                    <div class="tab-pane fade" id="requestBodySend" style="margin-left: 10px;margin-right: 10px">
                                        <button  id="openDivBtn" type="button" class="btn btn-primary btn-sm" style="margin-right: 1%;float: right;margin-top: -5px;margin-bottom: 10px;"  onclick="openDiv('getCaseList','bgdiv')">选择接口</button>
                                        <a  href="/interfaceTest/HTTP_InterfaceAddPage" target="_blank">
                                            <button  id="openDivBtn" type="button" class="btn btn-warning btn-sm" style="margin-right: 1%;float: right;margin-top: -5px;margin-bottom: 10px;"  >添加接口</button>
                                        </a>
                                        <div id="InterfacePage" style="margin-left: 10px;margin-right: 10px;margin-top: 15px;">
                                            <table id="sort" class="table table-striped table-bordered table-hover" style="table-layout:fixed;width:100%;word-break:break-all;">
                                                <thead>
                                                    <tr style="color: snow" bgcolor="#2A3F54">
                                                        <th style="width:2.5%;">序号</th>
                                                        <th style="width:10%;">接口编号</th>
                                                        <th style="width:10%;">接口名称</th>
                                                        <th style="width:20%;">接口描述</th>
                                                        <th style="width:20%;">接口URL</th>
                                                        <th style="width:10%;">创建人</th>
                                                        <th style="width:11%;">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="saveInterfaceList" >
                                                <td id="AllInterfaceTitle" colspan="7" align="center" >没有选择任何接口</td>
                                                </tbody>
                                            </table>
                                        </div>

                                    </div>

                                {% if option == "edit" or option == "check" %}
                                    <div class="tab-pane fade" id="requestBodyExecute" style="margin-left: 10px;margin-right: 10px">

                                        <div>
                                            {% include "config/debugBtnPage.html" %}
                                        </div>
                                        <div id="contractTaskExecuteDiv">
                                            <table class="table table-striped table-bordered table-hover"
                                                   style="table-layout:fixed;width:100%;word-break:break-all;margin-top:8px">
                                                <thead>
                                                <tr style="color: snow" bgcolor="#2A3F54">
                                                    <th style="width:2.5%;">执行编号</th>
                                                    <th style="width:4%;">任务编号</th>
                                                    <th style="width:4%;">任务名称</th>
                                                    <th style="width:5%;">执行备注</th>
                                                    <th style="width:3%;">执行环境</th>
                                                    <th style="width:4%;">调用接口总数量</th>
                                                    <th style="width:3%;">任务状态</th>
                                                    <th style="width:3%;">执行时长</th>
                                                    <th style="width:3%;">执行结果</th>
                                                    <th style="width:3%;">执行人</th>
                                                    <th style="width:5%;">执行时间</th>
                                                    <th style="width:4%;">操作</th>
                                                </tr>
                                                </thead>
                                                <tbody id="contrackTaskExecTbody">

                                                </tbody>
                                            </table>

                                        </div>
                                        </div>
                                        {% endif %}
                                </div>
                            </div>
                        </div>

                      <div>
                        <h2>MOCK响应信息</h2>
                      </div>
                       <div class="form-group"  >

                             <div class="form-group">
                                <div class="col-lg-2">
                                    <input  id="respStatusCode" placeholder="请输入响应状态码" type="text"  required="required" class="form-control col-md-2 col-xs-12" value="200">
                                </div>
                                 <div class="col-lg-2">
                                    <input  id="respStatusReason" placeholder="请输入响应状态描述" type="text"  required="required" class="form-control col-md-2 col-xs-12" value="OK">
                                 </div>
                                 <div class="col-lg-2">
                                    <input  id="respContentType" placeholder="请输入响应体数据类型，默认为空" type="text"  required="required" class="form-control col-md-2 col-xs-12" >
                                </div>
                                 <div class="col-lg-2">
                                    <input  id="respCharset" placeholder="请输入响应体数据编码，默认为空" type="text"  required="required" class="form-control col-md-2 col-xs-12" >
                                </div>
                              </div>

                                <div class="form-group">
                                    <div class="col-lg-8">
                                        <textarea type="text" id="respBody" required="required" class="form-control col-md-7 col-xs-12 Fixed-width"
                                        placeholder="请输入响应体"
                                        ></textarea>
                                    </div>
                                  </div>

                                    <div class="form-group">
                                <div class="col-lg-8">
                                    <table class="table" style="table-layout:fixed;">
                                        <thead>
                                            <tr style="color: snow" bgcolor="##2A3F54">
                                                <th style="font-weight: bold;width: 20%">CookieKey</th>
                                                 <th style="font-weight: bold">CookieValue</th>
                                            </tr>
                                        </thead>
                                        <tbody id="cookieTbody">
                                            <tr name="cookieTr">
                                                <td style="padding: 0px"><input class="form-control" onclick="addTableTr($(this).parent().parent().parent());" name="cookieKey"  style="background-color: rgb(183, 186, 189);border-radius:0px;"></td>
                                                <td style="padding: 0px"><input class="form-control" onclick="addTableTr($(this).parent().parent().parent());" name="cookieValue"  style="background-color: rgb(183, 186, 189);border-radius:0px;width:95%;">
                                                <button class="btn btn-danger" style="float: right; margin-top: -35px; display: none;" onclick="$(this).parent().parent().remove();"><i class="fa fa-trash"></i></button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                    </div>
                                <div class="form-group">
                                <div class="col-lg-8">
                                    <table class="table" style="table-layout:fixed;">
                                        <thead>
                                            <tr style="color: snow" bgcolor="##2A3F54">
                                                <th style="font-weight: bold;width: 20%">RespHeaderKey</th>
                                                 <th style="font-weight: bold">RespHeaderValue</th>
                                            </tr>
                                        </thead>
                                        <tbody id="respHeaderTbody">
                                            <tr name="respHeaderTr">
                                                <td style="padding: 0px"><input class="form-control" onclick="addTableTr($(this).parent().parent().parent());" name="respHeaderKey"  style="background-color: rgb(183, 186, 189);border-radius:0px;"></td>
                                                <td style="padding: 0px"><input class="form-control" onclick="addTableTr($(this).parent().parent().parent());" name="respHeaderValue"  style="background-color: rgb(183, 186, 189);border-radius:0px;width:95%;">
                                                <button class="btn btn-danger" style="float: right; margin-top: -35px; display: none;" onclick="$(this).parent().parent().remove();"><i class="fa fa-trash"></i></button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                    </div>

                         </div>

                        <div  style="display: block;">
                            <input type="checkbox" id="advanceModeCheck" onclick="checkAdvanceDivShow();" />高级模式
                        </div>

                       <div id="advanceDiv" class="form-group"  style="display: none;">
                           <div class="col-lg-8">
                                <textarea type="text" id="advancePythonCodeText" required="required" class="form-control Fixed-width"
                                placeholder="输入python代码"></textarea>
                            </div>
                            <div class="col-lg-8">
                                <H3>相关变量</H3>
                                <pre>
# 传入的变量，大家可以调用，做逻辑判断，返回等使用
"reqMethod":request.method,  # 实际请求的method，GET POST PUT DELTE 等等
"reqUrl":reqUrl, # 事情请求的接口url
"reqParam":reqParam, # 请求行中的参数字符串 k=1&m=2
"reqBody": reqBody,  # 请求体内容
"reqHeader": processedReqHeader,  # 请求header，key都是大写

"GET": request.GET, # GET的参数dict
"POST": request.POST, # POST的参数dict

# 以下为要赋值的字段
# 是否使用代码中的 resp相关的数据，不使用就使用默认的，只有为True的时候，赋值的resp相关的数据才会生效，如果isResp为False，
# 或者为True但是没有对resp*相关的参数进行重新赋值，那么resp*相关的值取MOCK响应信息中的值
"isResp": False,
"respStatusCode":respStatusCode, #返回的状态码，默认 200
"respStatusReason":respStatusReason, #返回的reason，默认 OK
"respContentType":respContentType, #返回的数据类型，默认None
"respCharset":respCharset, #返回的字符集，默认None
"respContent":respContent, #返回的响应体
"respCookie":respCookie, # json string 或者 ""空字符串
"respHeader":respHeader, # json string 或者 ""空字符串</pre>
                            <H3>默认引入的包</H3>
                                <pre>{{ importStr }}</pre>
                            </div>
                       </div>

                    </div>
                    <div class="ln_solid" ></div>
                    <div style="width:65%;" class="col-lg-12">
                    {% if option == "add" %}
                        {% if 'add' in  permissionsList %}
                        <button style="float: right" type="button" class="btn btn-success btn-lg" onclick="saveOrDebug('save')">&nbsp;&nbsp;&nbsp;&nbsp;保存&nbsp;&nbsp;&nbsp;&nbsp;</button>
                        {% endif %}
                    {% elif option == "check" %}
{#                        {% if "HTTP_interface_edit" in permission %}#}
                            <a href="{% url 'MOCK_HTTP_operationInterface' %}?id={{ id }}&option=edit">
                                <button style="float: right" type="button" class="btn btn-success btn-lg">&nbsp;&nbsp;&nbsp;&nbsp;编辑&nbsp;&nbsp;&nbsp;&nbsp;</button>
                            </a>
{#                        {% endif %}#}
{#                        {% if "HTTP_interface_copy" in permission %}#}
                            <a href="{% url 'MOCK_HTTP_operationInterface' %}?id={{ id }}&option=copy">
                                <button style="float: right" type="button" class="btn btn-success btn-lg" title="拷贝">&nbsp;&nbsp;&nbsp;&nbsp;拷贝&nbsp;&nbsp;&nbsp;&nbsp;</button>
                            </a>
{#                        {% endif %}#}
                    {% elif option == "copy" %}
{#                        {% if "HTTP_interface_add" in permission %}#}
                            <a href="javascript:void(0);">
                                <button style="float: right" type="button" class="btn btn-success btn-lg" onclick="saveOrDebug('save')">&nbsp;&nbsp;&nbsp;&nbsp;保存&nbsp;&nbsp;&nbsp;&nbsp;</button>
                            </a>
{#                        {% endif %}#}
                    {% elif option == "edit" %}
{#                            {% if "HTTP_interface_edit" in permission %}#}
                                <button style="float: right" type="button" class="btn btn-success btn-lg" onclick="saveOrDebug('edit')">&nbsp;&nbsp;&nbsp;&nbsp;保存&nbsp;&nbsp;&nbsp;&nbsp;</button>
{#                            {% else %}#}
{#                                    <button style="float: right" type="button" class="btn btn-success btn-lg" onclick="window.close()">&nbsp;&nbsp;&nbsp;&nbsp;关闭&nbsp;&nbsp;&nbsp;&nbsp;</button>#}
{#                            {% endif %}#}
                    {% endif %}
                    </div>
                  </div>


                </div>

                <!--选择单接口页面 start  弹出层 openDiv-->
                <div id="getCaseList" class="white_content x_panel" style="display: none;width:85%;margin-top: -35px" >
                  <div class="x_title">
                    <h2>选择HTTP接口</h2>
                    <div class="clearfix"></div>
                  </div>

                  <div class="x_content">
                    <div class="x_content">

                    <div class="form-group">
                        <div  id="checkOption">
                            <span class="cat-text" style="font-size: 15px;float: left;margin-right: 10px">搜索条件:</span>
                        </div>
                    </div>
                      <br>
                    <div class="" role="tabpanel" data-example-id="togglable-tabs">
                      <ul id="myTab" class="nav nav-tabs bar_tabs" role="tablist" style="margin-bottom: 0px">
                        <li role="presentation" class=""><a href="#caseFounder" role="tab" data-toggle="tab" aria-expanded="true">接口创建人</a>
                        </li>
                          <li role="presentation" class=""><a href="#caseId" role="tab" data-toggle="tab" aria-expanded="true">接口编号</a>
                        </li>
                        <li role="presentation" class=""><a href="#caseName" role="tab" id="profile-tab1" data-toggle="tab" aria-expanded="false">接口名称</a>
                        </li>
                        <li role="presentation" class=""><a href="#caseDescribe" role="tab" id="profile-tab21" data-toggle="tab" aria-expanded="false">接口描述</a>
                        </li>
                        <li role="presentation" class=""><a href="#uri" role="tab"  data-toggle="tab" aria-expanded="false">请求URI</a>
                        </li>
                        <li role="presentation" class="active"><a href="#caseInterFace" role="tab" id="profile-tab3" data-toggle="tab" aria-expanded="false">接口URL</a>
                        </li>
                      </ul>
                      <div id="myTabContent" class="tab-content">
                        <div role="tabpanel" class="tab-pane fade" id="caseFounder" aria-labelledby="home-tab">
                          <div class="form-group">
                            <div class="col-lg-8">
                                <input type="text" class="form-control" id="caseFounderInput" onkeypress="EnterPress(event)" placeholder="请输入接口创建人">
                            </div>
                              <div class="col-lg-4" >
                                  <span style="font-size: 15px;margin-top: 5px">快捷条件: </span>
                              <button type="button" class="btn btn-success btn-xs" style="margin-bottom: -1px" onclick="inputVal('all')">所有</button>
                              <button type="button" class="btn btn-success btn-xs" style="margin-bottom: -1px" onclick="inputVal('{{ request.session.userName }}')">{{ request.session.userName }}</button>
                              <button id="hover-a" type="button" class="btn btn-success btn-xs" style="margin-bottom: -1px" onclick="createPeople(0)">其他</button>
                                  <div id="names" style="margin-top: 10px">
                            </div>
                                  </div>

                          </div>
                        </div>
                        <div role="tabpanel" class="tab-pane fade" id="caseName" aria-labelledby="profile-tab">
                          <div class="form-group">
                            <div class="col-lg-8">
                                <input type="text" class="form-control" id="caseNameInput" onkeypress="EnterPress(event)" placeholder="请输入接口名称" >
                            </div>
                          </div>
                        </div>
                        <div role="tabpanel" class="tab-pane fade" id="caseId" aria-labelledby="profile-tab">
                          <div class="form-group">
                            <div class="col-lg-8">
                                <input type="text" class="form-control" id="interfaceIdInput" onkeypress="EnterPress(event)" placeholder="请输入接口编号" >
                            </div>
                          </div>
                        </div>
                        <div role="tabpanel" class="tab-pane fade" id="caseDescribe" aria-labelledby="profile-tab">
                          <div class="form-group">
                            <div class="col-lg-8">
                                <input type="text" class="form-control" id="caseDescribeInput" onkeypress="EnterPress(event)" placeholder="请输入接口描述">
                            </div>
                          </div>
                        </div>
                          <div role="tabpanel" class="tab-pane fade" id="uri" aria-labelledby="profile-tab">
                          <div class="form-group">
                            <div class="col-lg-8">
                                <input type="text" class="form-control" id="uriInput" onkeypress="EnterPress(event)" placeholder="请输入请求的URI">
                            </div>
                          </div>
                        </div>
                        <div role="tabpanel" class="tab-pane fade active in" id="caseInterFace" aria-labelledby="profile-tab">
                          <div class="form-group">
                            <div class="col-lg-8">
                                <input type="text" class="form-control" id="caseInterFaceInput"  onkeypress="EnterPress(event)" placeholder="请输入接口URL" >
                            </div>
                          </div>
                        </div>

                      </div>
                    </div>
                    <div id="taskList" class="form-group"></div>
                        <div class="widget-foot">
                            <button class="btn btn-info pull-right" style="margin-left: 20px" onclick="closeInterfaceList()">关闭</button>
                            <button class="btn btn-success pull-right" style="margin-left: 40px" onclick="showSaveInterface()">保存</button>
                            <div class="clearfix" ></div>
                        </div>

                    </div>
                  </div>

                </div>
                <!--选择单接口页面 end-->
              </div>

            </div>
          </div>


    </div>
</div>

<script type="text/javascript">
    var optionInUrl = "{{ option }}";
    $("#businessLine").select2();
    $("#modules").select2();
    $("#methodSelect").select2();
    $("#URI").select2();
    $("#runContractTaskHttpConfSelect").select2();
    var pythonCodeEditor = null;
    function initJudgeVersion() {
     if ("{{ request.session.version }}" !== "CurrentVersion"){
         alert("现在为历史版本页面")
     }
    }
    initJudgeVersion();
    var businessLine_module_relation = $.ajax({
                  url: '{% url 'bmRelation' %}' ,
                  type: 'get',
                  async: false,
             });
    try{
        var bmDict = JSON.parse(businessLine_module_relation.responseText).body;
    }catch (e){
        alert(bmDict);
        alert("获取业务线模块关联失败")
    }
    switchModule($("#businessLine").val());

    function switchModule(blId) {
        $("#modules option").remove();
        var mdSelect = $("#modules");
        for(var index = 0; index < bmDict[blId].length;index ++){
            jQuery("<option></option>").val(bmDict[blId][index]["id"]).text(bmDict[blId][index]["moduleName"]).appendTo(mdSelect);
        }
    }

    var checkResultId = 0;
    var data = {};

    function checkAdvanceDivShow(){
        if($("#advanceModeCheck").prop("checked")){
            $("#advanceDiv").show();
            if(pythonCodeEditor == null){
                pythonCodeEditor = CodeMirror.fromTextArea($("#advancePythonCodeText")[0], {
                    lineNumbers: true,
                    matchBrackets: true,
                    mode: "text/x-python",
                    indentUnit: 4,
                    indentWithTabs: false
                });
                pythonCodeEditor.setOption("extraKeys", {
                    Tab: newTab
                });
            }
        }else{
            $("#advanceDiv").hide();
        }
    }
    function toggleUrlEncode(element,tableName) {
        if(element.text()=="原始"){
            element.parent().parent().parent().parent().css("display","none");
            element.parent().parent().parent().parent().next().css("display","block");
            var tableData = tableDataTourlencode(tableName);
            element.parent().parent().parent().parent().next().children().val(tableData);
        }else {
            element.parent().css("display","none");
            element.parent().prev().attr("style","table-layout: fixed;");
            tableInitList(tableName,urlencodeToList(element.next().val()));
        }
    }

    function formDataTabInit(jsonModel) {
        for(var i = 0 ; i < jsonModel.length ; i++){
            addTableTr($("#body-form-Tbody"));
            var element = $("[name='body-form-Tr']").eq(i);
            var elementKeyTd = element.children().eq(0).children();
            var elementValueTd = element.children().eq(1).children();
            elementKeyTd.eq(0).val(jsonModel[i]["key"]);
            elementKeyTd.eq(1).val(jsonModel[i]["type"]);

            formDataInput_file( element.children().eq(0).children().eq(1));
            if(jsonModel[i]["type"] == "text"){
                elementValueTd.eq(0).val(jsonModel[i]["value"]);
            }else{
                elementValueTd.eq(2).children().eq(1).val(jsonModel[i]["value"]["showPath"]);
                elementValueTd.eq(2).children().eq(2).text(JSON.stringify(jsonModel[i]["value"]));
            }

        }
    }

    function tableInit(elementName,jsonModel) {
        if(JSON.stringify(jsonModel) != "{}") {
            var i = 0;
            for (var key in jsonModel) {
                if (i == ($("[name='" + elementName + "Tr']").length - 1)) {
                    addTableTr($("#" + elementName + "Tbody"));
                }
                var element = $("[name='" + elementName + "Tr']").eq(i).find('td');
                var headerKey = element.eq(0).children();
                var headerValue = element.eq(1).children().eq(0);
                headerKey.val(key);
                headerValue.val(jsonModel[key]);
                if(key != "" || jsonModel[key] != ""){
                     i++;
                }
            }
            var htmlElement = $("[name='" + elementName + "Tr']");
            for(var j=0;j<htmlElement.length;j++){
                if(j > i){
                    htmlElement.eq(j-1).remove();
                }
            }

        }else {
            var htmlElement = $("[name='" + elementName + "Tr']");
            for(var i=0;i<htmlElement.length-1;i++){
                htmlElement.eq(i).remove();
            }
        }
    }


     function tableInitList(elementName,urlencodeList) {
        for(var i=0;i<urlencodeList.length;i++){
             if (i == ($("[name='" + elementName + "Tr']").length - 1)) {
                    addTableTr($("#" + elementName + "Tbody"));
                }
             var element = $("[name='" + elementName + "Tr']").eq(i).find('td');
             var headerKey = element.eq(0).children();
             var headerValue = element.eq(1).children().eq(0);
            headerKey.val(urlencodeList[i][0]);
            headerValue.val(urlencodeList[i][1]);
        }
    }

      function addTableTr(element) {
                var lastElement = element.children().last();
                var lastElementHtml = lastElement.prop("outerHTML");
                lastElement.after(lastElementHtml);
                tableStyle(element)
            }

          function tableStyle(element) {
                var elementList = element.children();
                for(var i=0;i<elementList.length;i++){
                    var elementInput = elementList.eq(i).find("input");
                    if(i != (elementList.length - 1)){
                         elementInput.css("background-color", "");
                         elementInput.attr("onclick", "");
                         elementList.eq(i).find("button").css("display", "block");
                         elementList.eq(i).find("select").attr("disabled", false);
                         elementList.eq(i).find("select").css("background-color", "");
                    }else {
                         elementInput.css("background-color", "rgb(183, 186, 189)");
                         elementList.eq(i).find("button").css("display", "none");
                         elementList.eq(i).find("select").css("background-color", "rgb(183, 186, 189)");
                         elementList.eq(i).find("select").attr("disabled", true);
                    }
                }
            }



    function clickBodyRadio() {
        var checkedRadio =  $("input[name='body']:checked").val();
        if (checkedRadio == "form-data"){
            $("#body-form-data").css("display","block");
            $("#body-x-www-form-urlencoded").css("display","none");
            $("#body-raw-select").css("display","none");
            $("#body-raw").css("display","none");
            $("#body-binary").css("display","none");
        }else if(checkedRadio == "x-www-form-urlencoded"){
            $("#body-x-www-form-urlencoded").css("display","block");
            $("#body-form-data").css("display","none");
            $("#body-raw-select").css("display","none");
            $("#body-raw").css("display","none");
            $("#body-binary").css("display","none");
        }else if(checkedRadio == "raw"){
            $("#body-raw-select").css("display","block");
            $("#body-raw").css("display","block");

            $("#body-x-www-form-urlencoded").css("display","none");
            $("#body-form-data").css("display","none");
            $("#body-binary").css("display","none");
        }else {
            $("#body-raw-select").css("display","none");
            $("#body-raw").css("display","none");

            $("#body-x-www-form-urlencoded").css("display","none");
            $("#body-form-data").css("display","none");
            $("#body-binary").css("display","block");
        }

    }

    function formDataInput_file(element) {
        if(element.val() == "text"){
            element.parent().next().find("input").eq(0).css("display","block");
            element.parent().next().find("div").css("display","none");
            element.parent().next().find("button").css("margin-top","-32.5px")
        }else{
            element.parent().next().find("div").css("display","block");
            element.parent().next().find("input").eq(0).css("display","none");
            element.parent().next().find("button").css("margin-top","2px")
        }
    }


    function tableDataToDict(tabName) {
        var tableTr = $("[name='"+tabName+"Tr']");
        var tableJson = {};
        if(tableTr.length!=0){
            for(var i = 0;i < tableTr.length; i++){
                if(tableTr.eq(i).find("td").eq(0).children().val().trim() == "" && tableTr.eq(i).find("td").eq(1).children().val().trim() == ""){
                    continue;
                }
                tableJson[tableTr.eq(i).find("td").eq(0).children().val().trim()] = tableTr.eq(i).find("td").eq(1).children().val().trim()
            }
        }
        return tableJson;
    }

    function tableDataTourlencode(tabName) {
        var tableTr = $("[name='"+tabName+"Tr']");
        var tableStr = "";
        if(tableTr.length!=0){
            for(var i = 0;i < tableTr.length; i++){
                if(tableTr.eq(i).find("td").eq(0).children().val().trim() == "" && tableTr.eq(i).find("td").eq(1).children().val().trim() == ""){
                    continue;
                }
                tableStr += tableTr.eq(i).find("td").eq(0).children().val().trim()+"="+tableTr.eq(i).find("td").eq(1).children().val().trim();
                if(i != (tableTr.length-2)){
                    tableStr += "&";
                }
            }
        }
        return tableStr;
    }


    function changeHeader(codeType) {
        var headerJson = tableDataToDict("header");
        if(codeType == "" || codeType == "Text"){
            if(headerJson["Content-Type"]){
                delete headerJson["Content-Type"];
            }
        }else{
            headerJson["Content-Type"] = codeType
        }
        tableInit("header",headerJson);
        $("[href='#headerTab']").text("HEADER("+($("[name='headerTr']").length-1)+")")

    }

    function changeBodyTab(method) {
        if(method == "GET" || method == "HEAD"){
             $("[href='#bodyTab']").parent().css("display","none");
             $("[href='#paramsTab']").click();
        }else {
             $("[href='#bodyTab']").parent().css("display","block");
             $("[href='#bodyTab']").click();
        }

    }

    function changeSelectWidth(codeType) {
        switch (codeType.val()) {
            case "Text":
                codeType.css("width","80px");
                break;
            case "text/plain":
                codeType.css("width","150px");
                break;
            case "application/json":
                codeType.css("width","200px");
                break;
            case "application/javascript":
                codeType.css("width","260px");
                break;
            case "application/xml":
                codeType.css("width","200px");
                break;
            case "text/xml":
                codeType.css("width","150px");
                break;
            case "text/html":
                codeType.css("width","150px");
                break;
        }
    }

    function urlencodeToList(str) {
        if(str == ""){
            return []
        }
        var strList = str.split("&");
        var retList = [];
        for (var s in strList){
            var sp = strList[s].split("=");
            if(sp.length == 1){
                retList.push(["",sp[0]])
            }else {
                var strText = "";
                for(var i = 1;i<sp.length;i++){
                    if(i == sp.length -1){
                        strText = strText + sp[i]
                    }else {
                        strText = strText+ sp[i]+"="
                    }
                }
                retList.push([sp[0],strText])
            }
        }
        return retList;
    }

    function urlencodeToDict(str) {
        var strList = str.split("&");
        var strdict = {};
        for (var s in strList){
            var sp = strList[s].split("=");
            strdict[sp[0]] = sp[1]
        }
        return strdict;
    }

    function dataInit() {
        if (optionInUrl != "add") {
            if (optionInUrl  == "select" || optionInUrl == "caseCheck") {

                $("[type='text']").attr("disabled", true);
                $("select").attr("disabled", true);
                $("input").attr("onclick", "");
                $("input").attr("disabled", true);
                $("[type='radio']").attr("disabled", true);

            }

            $("#preTab").children().eq(0).attr("class","");
            $("#preTab").children().eq(0).attr("class","active");
            $("#preTabContent").children().eq(0).attr("class","tab-pane fade");
            $("#preTabContent").children().eq(0).attr("class","tab-pane fade active in");

            $("#interfaceTab").children().eq(0).attr("class","");
            $("#interfaceTab").children().eq(0).attr("class","active");
            $("#interfaceTabContent").children().eq(0).attr("class","tab-pane fade");
            $("#interfaceTabContent").children().eq(0).attr("class","tab-pane fade active in");

            $("#afterTab").children().eq(0).attr("class","");
            $("#afterTab").children().eq(0).attr("class","active");
            $("#afterTabContent").children().eq(0).attr("class","tab-pane fade");
            $("#afterTabContent").children().eq(0).attr("class","tab-pane fade active in");

            var ajaxobj = $.ajax({
                url: "{% url 'MOCK_getInterfaceDataForId' %}?id={{ id }}", type: "GET", success: function () {
                    var data = JSON.parse(JSON.parse(ajaxobj.responseText).body);
                    $("#interfaceId").val(data["mockId"]);
                    $("#name").val(data["title"]);
                    $("#describe").val(data["describe"]);
                    $("#tagKey").val(data["tagKey"]);
                    $("#businessLine").val(data["businessLineId"]).change();
                    $("#businessLine").select2();
                    try {
                        $("#modules").val(data["moduleId"]);
                        $("#modules").select2();
                    }catch (e){

                    }
                    var uriflag = 0;
                    $("#URI").children().each(function () {
                        if ($(this).val() == data["uriKey"]) {
                            uriflag++;
                            $(this).attr("selected", true);
                        }
                    });
                    if (uriflag == 0) {
                        $("[value='输入URI']").attr("selected", true);
                        $("#URIInput").val(data["uri"]);
                    }
                    $("#URL").val(data["reqUrl"]);
                    $("#methodSelect").children().each(function () {
                        if ($(this).val() == data["reqMethod"]) {
                            $(this).attr("selected", true);
                        }
                    });
                    $("#methodSelect").select2()
                    $("#URI").select2();
                    if (data["reqHeader"] !== ""){
                        tableInit("header",JSON.parse(data["reqHeader"]));
                    }
                    if (data["respCookie"] !== ""){
                        tableInit("cookie",JSON.parse(data["respCookie"]));
                    }
                    if (data["respHeader"] !== ""){
                        tableInit("respHeader",JSON.parse(data["respHeader"]));
                    }
                    changeBodyTab(data["reqMethod"]);
                    if (data["mockMode"] == 1){
                        $("#advanceModeCheck").prop("checked",true);
                        checkAdvanceDivShow();
                        pythonCodeEditor.setValue(data["advancedPythonCode"]);
                    }

                    $("[href='#headerTab']").text("HEADER("+($("[name='headerTr']").length-1)+")");
                    var parameter = $("#parameter");
                    var paramsFlag = 0;
                    var paramsList = urlencodeToList(data["reqParam"]);
                    for (var paramsIndex = 0;paramsIndex<paramsList.length;paramsIndex++){
                        if (paramsList[paramsIndex][0] == "" || paramsList[paramsIndex][1] == ""){
                            paramsFlag = 1;
                        }
                    }
                    if (paramsFlag == 0){
                        tableInitList("params",urlencodeToList(data["reqParam"]));
                    }else {
                        parameter.parent().parent().children().eq(0).css("display", "none");
                        parameter.parent().parent().children().eq(1).css("display", "block");
                        parameter.val(data["reqParam"]);
                    }
                    $("#body-raw-input").val(data["reqBody"]);
                    $("#respBody").val(data["respBody"]);
                    $("#respStatusCode").val(data["respStatusCode"]);
                    $("#respStatusReason").val(data["respStatusReason"]);
                    $("#respCharset").val(data["respCharset"]);
                    $("#respContentType").val(data["respContentType"]);

                    //遍历关联接口
                    var interfaceIdList = data["interfaceList"];
                    if(interfaceIdList.length > 0){
                        $("#saveInterfaceList").children("tr").eq(0).css("display","none");
                        for (var interfaceIndex=0;interfaceIndex<interfaceIdList.length;interfaceIndex++) {
                            var tmpInterface = interfaceIdList[interfaceIndex];
                            $("#saveInterfaceList").append('<tr name="interfaceTr"  onclick="trColor($(this))">\
                <td class="index" name="interfaceTRId" style="width: 10%">'+(interfaceIndex+1)+'</td>\
                <td name="interfaceFlag">'+HTMLEncode(tmpInterface.interfaceId)+'</td>\
                <td><textarea class="table-fixed-write" style="height:auto"  disabled>'+ HTMLEncode( tmpInterface.title)+'</textarea></td>\
                <td><textarea class="table-fixed-write" style="height:auto"  disabled>'+HTMLEncode(tmpInterface.casedesc)+'</textarea></td>\
                <td><textarea class="table-fixed-write" style="height:auto"  disabled>'+HTMLEncode(tmpInterface.url)+'</textarea></td>\
                <td>'+ tmpInterface.addBy_id+'</td>\
                <td>\
                <div style="margin-top: -10px">\
                <button class="btn btn-success optionButtionSize" style="margin-top:10px" value="'+tmpInterface.interfaceId+'" name="interfaceCopy" onclick="copyTr($(this))" title="拷贝"><i class="fa fa-copy"></i></button>\
                <a href="/interfaceTest/HTTP_operationInterfaceByInterfaceId?option=check&interfaceId='+tmpInterface.interfaceId+'" target="_blank" ><button class="btn btn-info optionButtionSize" style="margin-top:10px" value="'+tmpInterface.interfaceId+'" name="interfaceCopy" title="查看"><i class="fa fa-info-circle"></i></button></a>\
               <button class="btn btn-danger optionButtionSize" style="margin-top:10px" value="'+tmpInterface.interfaceId+'" name="interfaceDel" onclick="delTr($(this))" title="删除"><i class="fa fa-trash"></i></button>\
               </div>\
               </td>\
                </tr>');
                        }
                    }

                    //初始化执行列表
                    initContractExecuteResultTable();
                }
            });
        }
    }

    //获取url中的参数
    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
        var r = window.location.search.substr(1).match(reg);  //匹配目标参数
        if (r != null) return unescape(r[2]); return null; //返回参数值
    }


    function result() {
        window.close();
        window.opener.location.href = '/InterfaceTest/HttpInterfaceCheck';
    }

    function moreEnv() {
        if ($('#debugMoreEnv').css("display") == "none") {
            $('#debugMoreEnv').css("display", "block");
        } else {
            $('#debugMoreEnv').css("display", "none");
        }
    }

    function HTMLEncode(html) {
        var temp = document.createElement("div");
        (temp.textContent != null) ? (temp.textContent = html) : (temp.innerText = html);
        var output = temp.innerHTML;
        temp = null;
        return output;
    }

    //查看接口调试详情
    function checkDebugCase(id) {
        $('#resultDetailstr' + id).toggle();
        $('#resultDetails' + id).toggle();
    }
   //跳到事件的地方
    function ShowDiv(element){
        obshowdiv =  element;
        offtop=obshowdiv.offset().top-155;
        offleft=obshowdiv.offset().left;
        obshowdiv.show();
        docheight = $(document).height();
        $('html,body').animate({scrollTop:offtop}, 200);
    }

    function clearResult() {
        $("#debugResultTbody").children().remove();
        checkResultId = 0;
        $("#debugResult").hide();
        $('#clearResult').hide();
    }


    function valLengthVerify(option) {
        if(option !== "debug"){
             if ($("#name").val() == "") {
                alert("接口名称不能为空");
                return false;
            }
        }

        if ($("#URI").val() == "输入URI") {
            if ($("#URIInput").val() == "") {
                alert("URI不能为空");
                return false;
            }
        }

        if ($("#URL").val() == "") {
            alert("接口不能为空");
            return false;
        }else if($("#URL").val().indexOf("?")!=-1){
            alert("url中不能包含问号，参数请填写params，问号自动拼接");
            return false
        }

        var result = true;
        if ($("input[name='body']:checked").val() == "form-data") {
            var fileInput = $("[name='body-form-Tr']");
            fileInput.each(function () {
                var thisElement = $(this).children().eq(0).children();
                if (thisElement.css("background-color") != "rgb(183, 186, 189)") {
                    if (thisElement.val() == "") {
                        alert("form-data的Key值不能为空");
                        result =  false;
                    }
                }
            })
        }
        return result;
    }

    function saveOrDebug(option, httpConfKey) {
        if (valLengthVerify(option) == false){
            return;
        }

        var formData = new FormData();

        var interfaceId = '';
        if (optionInUrl != "add") {
            interfaceId = $("#interfaceId").val();
        }

        var title = $("#name").val();
        var describe = $("#describe").val();
        var tagKey = $("#tagKey").val();

        var businessLineId = $("#businessLine option:selected").val();

        var moduleId = $("#modules option:selected").val();
        if (!moduleId){
            alert("请选择模块");
            return
        }
        var uri = $("#URI").val();
        var method = $("#methodSelect").val();
        var header = JSON.stringify(tableDataToDict("header"));
        var url = $("#URL").val();
        var paramsElement = $("#parameter");
        if (paramsElement.parent().css("display") == "none") {
            var params = tableDataTourlencode("params");
        } else {
            var params = paramsElement.val();
        }
        var bodyContent = '';
        if (method != "GET" && method !="HEAD") {
            bodyContent = $("#body-raw-input").val();
        }

        var respCookie = JSON.stringify(tableDataToDict("cookie"));
        var respHeader = JSON.stringify(tableDataToDict("respHeader"));
        var respStatusCode = $("#respStatusCode").val();
        var respStatusReason = $("#respStatusReason").val();
        var respContentType = $("#respContentType").val();
        var respCharset = $("#respCharset").val();
        var respBody = $("#respBody").val();
        var isAdvanceChecked = $("#advanceModeCheck").prop("checked");
        var mockMode = 0;
        var advancedPythonCode  = "";
        if(isAdvanceChecked){
            mockMode = 1;
            advancedPythonCode = pythonCodeEditor.getValue();
            if (advancedPythonCode.indexOf("import ") != -1){
                alert("不能执行import，如果有import需求，请联系管理员！");
                return;
            }
        }
        //遍历关联接口
        var trList = $("#saveInterfaceList").children("tr");
        var interfaceIdsStr = "";
        for (var i=1;i<trList.length;i++) {
            var tdArr = trList.eq(i).find("td");
            interfaceIdsStr += tdArr.eq(1).text() + ",";
        }
        var interfaceData = {
            mockId: interfaceId,
            title: title,
            describe: describe,
            tagKey: tagKey,
            businessLineId: businessLineId,
            moduleId: moduleId,

            uriKey: uri,
            reqMethod: method,
            reqHeader: header,
            reqUrl: url,
            reqParam: params,
            reqBody:bodyContent,

            respCookie:respCookie,
            respHeader:respHeader,
            respStatusCode:respStatusCode,
            respStatusReason:respStatusReason,
            respContentType:respContentType,
            respCharset:respCharset,
            respBody:respBody,
            mockMode:mockMode,
            advancedPythonCode:advancedPythonCode,
            interfaceIds:interfaceIdsStr
        };

        if (option == "save") {
            formData.append("interfaceData",JSON.stringify(interfaceData));
             var interfaceAdd = $.ajax({
                  url: '{% url 'MOCK_HTTP_InterfaceAdd' %}' ,
                  type: 'POST',
                  data: formData,
                  async: false,
                  cache: false,
                  contentType: false,
                  processData: false
             });


            var interfaceAddJson = JSON.parse(interfaceAdd.responseText);
            if (interfaceAddJson["code"] == "10000") {
                if (option == 'copy') {
                    window.close();
                    window.opener.location.reload();
                } else {
                    location.href = '{% url 'MOCK_HTTP_InterfaceCheck' %}';
                }
            } else {
                alert(interfaceAddJson["message"]);
            }
        }
        else if (option == "edit") {
                interfaceData.id = data["id"];
                interfaceData.addBy = data["addBy"];
                formData.append("interfaceData",JSON.stringify(interfaceData));
                formData.append("id",{{ id }});
                 var saveEditAjax = $.ajax({
                      url: '{% url 'MOCK_HTTP_InterfaceSaveEdit' %}' ,
                      type: 'POST',
                      data: formData,
                      async: false,
                      cache: false,
                      contentType: false,
                      processData: false
                 });
                var retdict = JSON.parse(saveEditAjax.responseText);
                if (retdict["code"] == 10000) {
                    if(confirm(retdict["message"] + "，是否退出编辑？")) {
                        window.close();
                        window.opener.location.reload();
                    }
                } else {
                    alert(retdict["message"]);
                }
            }
        else if (option == "debug"){
            var runContractResult = $.ajax({
                  url: '{% url 'MOCK_RunContrackTask' %}?mockId='+$("#interfaceId").val()+"&httpConfKey="+httpConfKey ,
                  type: 'GET',
                  async: false
             });
            var retDict = JSON.parse(runContractResult.responseText);
            if (retDict['code'] == 10000){
                initContractExecuteResultTable();
            }else{
                alert(retDict["message"]);
            }
            checkUpdateData();
        }

    }
    function initContractExecuteResultTable(){
        var contractRunInfos = $.ajax({
              url: '{% url 'MOCK_getContrackTaskRecentExecInfos' %}?mockId='+$("#interfaceId").val() ,
              type: 'GET',
              async: false
         });
        var retDict = JSON.parse(contractRunInfos.responseText);
        if(retDict['code'] == 10000){
            var contrackTaskHtml = "";
            var dataList = retDict['body'];
            for(var cIndex=0; cIndex< dataList.length; cIndex++){
                var tmpData = dataList[cIndex];
                var execResultTdHtml = '';
                var reportBtnHtml = '';
                if(tmpData['testResult']=="PASS"){
                    execResultTdHtml = '<span class="label label-success" style="font-size: 13px;">通过</span>';
                }else if(tmpData['testResult']=="FAIL"){
                    execResultTdHtml = '<span class="label label-danger" style="font-size: 13px;">失败</span>';
                }else if(tmpData['testResult']=="ERROR"){
                    execResultTdHtml = '<span class="label label-danger" style="font-size: 13px;">错误</span>';
                }else if(tmpData['testResult']=="EXCEPTION"){
                    execResultTdHtml = '<span class="label label-warning" style="font-size: 13px;">异常</span>';
                }else if(tmpData['testResult']=="CANCEL"){
                    execResultTdHtml = '<span class="label label-default" style="font-size: 13px;">取消</span>';
                }else{
                    execResultTdHtml = '-';
                }
                var execStatusTdHtml = '';
                var refreshButtonHtml = '';
                if(tmpData['execStatus']=="1"){
                    execStatusTdHtml = '<div name="waitUpdate" name1="'+tmpData['id']+'" class="label label-primary" style="font-size: 13px;">队列中</span>';
{#                    refreshButtonHtml = '<a href="javascript:void(0);" class="btn btn-warning optionButtionSize"  style="margin-top: -10px;margin-left:10px;" target="_blank" title="刷新" onclick="initContractExecuteResultTable()">' +#}
{#                        '<i class="fa fa-refresh"></i>' +#}
{#                        ' </a>';#}
                }else if(tmpData['execStatus']=="2"){
                    execStatusTdHtml = '<div id="progressTitle_'+tmpData['id']+'" class="progress  progress-striped active" title="通过0,失败0,错误0">\
                                    <div id="progressData_'+tmpData['id']+'" class="progress-bar progress-bar-success" data-percentage="100" style="width: 0%;">0%</div>\
                            </div>';
{#                    refreshButtonHtml = '<a href="javascript:void(0);" class="btn btn-warning optionButtionSize"  style="margin-top: -10px;margin-left:10px;" target="_blank" title="刷新" onclick="initContractExecuteResultTable()">' +#}
{#                        '<i class="fa fa-refresh"></i>' +#}
{#                        ' </a>';#}
                }else if(tmpData['execStatus']=="3"){
                    execStatusTdHtml = '<span class="label label-success" style="font-size: 13px;">完成</span>';
                    reportBtnHtml = '<a href="'+tmpData['testReportUrl']+'" class="btn btn-info optionButtionSize"  style="margin-top: -10px" target="_blank" title="查看报告">'+
                        '<i class="fa fa-file"></i>'+
                        '    </a>';
                }else if(tmpData['execStatus']=="4"){
                    execStatusTdHtml = '<span class="label label-danger" style="font-size: 13px;border-color: yellow;">异常</span>';
                    reportBtnHtml = '<a href="'+tmpData['testReportUrl']+'" class="btn btn-info optionButtionSize"  style="margin-top: -10px" target="_blank" title="查看报告">'+
                        '<i class="fa fa-file"></i>'+
                        '    </a>';
                }else if(tmpData['execStatus']=="10"){
                    execStatusTdHtml = '<span class="label label-warning" style="font-size: 13px;">待取消</span>';
                }else if(tmpData['execStatus']=="11"){
                    execStatusTdHtml = '<span class="label label-default" style="font-size: 13px;">已取消</span>';
                }


                contrackTaskHtml += '<tr>' +
                    '<td>'+tmpData['id']+'</td>' +
                    '<td>'+tmpData['taskId']+'</td>' +
                    '<td>'+tmpData['title']+'</td>' +
                    '<td>'+tmpData['execComments']+'</td>' +
                    '<td>'+tmpData['httpConfKey']+'</td>' +
                    '<td>'+tmpData['interfaceNum']+'</td>' +
                    '<td id="progressTD_'+tmpData['id']+'">'+execStatusTdHtml+'</td>' +
                    '<td>'+tmpData['execTakeTime']+'</td>' +
                    '<td>'+execResultTdHtml+'</td>' +
                    '<td>'+tmpData['execBy']+'</td>' +
                    '<td>'+tmpData['execTime']+'</td>' +
                    '<td>'+reportBtnHtml+'</td>' +
                    '</tr>';
            }
            if(contrackTaskHtml==""){
                contrackTaskHtml = '<tr><td colspan="12">没有执行结果！</td></tr>';
            }
            $("#contrackTaskExecTbody").html(contrackTaskHtml);
            checkUpdateData();
        } else{
            console.log(retDict);
            alert(retDict['message']);
        }

    }

    function checkUpdateData() {
        var elementList = $("[name='waitUpdate']");
        if (elementList.length > 0){
            var elementIdList = new Array();
            for (var index = 0;index < elementList.length;index ++){
                elementIdList.push(elementList.eq(index).attr("name1"));
            }

             var updateProgressData = $.ajax({
                url:"{% url 'HTTP_UpdateTaskExecuteProgressData' %}",
                data:{"taskExecuteIds":elementIdList.join(",")},
                type:"POST",
                async:true,
                success:function () {
                try{
                    var updateProgressDataJson = JSON.parse(updateProgressData.responseText);
                    var progressDict = updateProgressDataJson["body"];
                    for(var progressIndex in progressDict){
                        var progressTD = $("#progressTD_"+progressIndex);
                        if(progressDict[progressIndex]["status"] === "2" && $("#progressTitle_"+progressIndex).length === 0){
                            progressTD.html('<div id="progressTitle_'+progressIndex+'" name="waitUpdate"  name1="'+progressIndex +'" class="progress  progress-striped active" title="通过0,失败0,错误0">\
                                    <div id="progressData_'+progressIndex+'" class="progress-bar progress-bar-success" data-percentage="100" style="width: 0%;">0%</div>\
                            </div>')
                        }
                        $("#progressTitle_"+progressIndex).attr("title","通过"+progressDict[progressIndex]["passCount"]+",失败"+progressDict[progressIndex]["failCount"]+",错误"+progressDict[progressIndex]["errorCount"]);
                        $("#progressData_"+progressIndex).attr("class","progress-bar progress-bar-"+progressDict[progressIndex]["execColor"]);
                        $("#progressData_"+progressIndex).text(progressDict[progressIndex]["passPercent"]+"%");
                        $("#progressData_"+progressIndex).css("width",progressDict[progressIndex]["passPercent"]+"%");
                    }
                    if(updateProgressDataJson["code"] === 11000){
                        setTimeout("initContractExecuteResultTable()",1000);
                    }else if(updateProgressDataJson["code"] === 10000) {
                        setTimeout("checkUpdateData()",1000);
                    }


                }catch (e){

                    alert("页面刷新发生异常，请联系管理员，异常信息为："+e)

                }
            }})

        }
    }

    function pageInit() {
        dataInit();
    }

    pageInit();
    window.onload = function () {
        $("#surprise").click();
        $("#surprise2").click();
    };


    //关联接口信息相关的js
    var checkVals =  {"caseFounder":"","interfaceId":"","title":"","casedesc":"","uri":"","url":""};
    var orderBy = "i.modTime desc , i.id desc";
    var interfacePage = 1;
    var interfaceNameFlag = "-1";
    var addTimeFlag = '-1';
    var modTimeFlag = '-1';
    var interfaceList = Array();
    //限制一共只能勾一千 条
    var interfaceNum = 0;
    var interfaceNumMax = 2000;
    var interfaceData = {};
    //弹出隐藏层
    function openDiv(show_div,bg_div){
        //弹出详情层
        obshowdiv =  $('#'+show_div);
        objclosediv = $('#'+show_div+'> label');
        obbgdiv = $('#'+bg_div);
        offtop=obshowdiv.offset().top;
        offleft=obshowdiv.offset().left;
        obshowdiv.css("top",offtop+40+"px");
        objclosediv.css("top","40px");
        objclosediv.css("left","90%%");
        obshowdiv.show();
        obbgdiv.show();
        docheight = $(document).height();
        obbgdiv.height(docheight);
        $('html,body').animate({scrollTop:offtop}, 800);
        checkVals['url'] = $("#URL").val();
        $("#caseInterFaceInput").val($("#URL").val());
        checkVals['uri'] = $("#URI").val();
        $("#uriInput").val($("#URI").val());
        selected();
        $("#surprise3").click();
        $("#openDivBtn").attr("disabled", true);
        interfaceListIsChecked();

    }
    //关闭弹出层
    function CloseDiv(show_div,bg_div){
        $("#openDivBtn").attr("disabled", false);
        $("#openTestCaseDivBtn").attr("disabled", false);
        $('#'+show_div).hide();
        $('#'+bg_div).hide();
    }
    function closeInterfaceList() {
        $("#surprise3").click();
        CloseDiv("getCaseList", "bgdiv");
//            auto();
    }
    function interfaceListIsChecked() {

        for(var i=0;i<interfaceList.length;i++){
            $("#"+interfaceList[i]).prop("checked",true);
        }
        var allcheck = 1;
        $("[name='interfaceCheckbox']").each(function () {
            if(!$(this).is(':checked')){
                allcheck = 0;
            }
        });
        if(allcheck == 1){
            $("#checkboxAll").prop("checked",true);
        }
    }
    function EnterPress(event){ //传入 event
        var e = event || window.event;
        if(e.keyCode == 13){
            editCheckVal();

        }
    }
    function editCheckVal() {

        //接口创建人
        if($("#caseFounderInput").val()==''){
            checkVals['caseFounder'] = '';
        }else if($("#caseFounderInput").val()=='all'){
            checkVals['caseFounder'] = '';
        }else{
            checkVals['caseFounder'] =$("#caseFounderInput").val() ;
        }

        //接口Id
        if($("#interfaceIdInput").val()==''){
            checkVals['interfaceId'] = '';
        }else {
            checkVals['interfaceId'] =$("#interfaceIdInput").val() ;
        }

        //接口名称
        if($("#caseNameInput").val()==''){
            checkVals['title'] = '';
        }else {
            checkVals['title'] =$("#caseNameInput").val() ;
        }


        //接口描述
        if ($("#caseDescribeInput").val()==''){
            checkVals['casedesc']='';
        }else {
            checkVals['casedesc']=$("#caseDescribeInput").val();
        }

        //服务
        if ($("#uriInput").val()==''){
            checkVals['uri']='';
        }else {
            checkVals['uri']=$("#uriInput").val();
        }
        //服务
        if ($("#caseInterFaceInput").val()==''){
            checkVals['url']='';
        }else {
            checkVals['url']=$("#caseInterFaceInput").val();
        }
        if ($("#caseModuleInput").val()==''){
            checkVals['module']='';
        }else {
            checkVals['module']=$("#caseModuleInput").val();
        }

        selected();
    }

    function selected() {
        checkOptions();
        var data = {checkArr : encodeURI(JSON.stringify(checkVals)),orderBy : orderBy,interfacePage:interfacePage};
        htmlobj=$.ajax({url:"{% url 'HTTP_TaskSelectInterfacePage' %}",async:false,data:data,type:"POST"});
        $("#taskList").html(htmlobj.responseText);
        orderByShow();
        interfaceListIsChecked();
    }
    function checkOptions() {

        var htmls = ' <span class="cat-text"style="font-size: 15px;float: left;margin-right: 10px">搜索条件:</span>';
        var num =0;
        var writeNum = 0;

        for(var item in checkVals){
            if(checkVals[item] != '' && typeof(checkVals[item]) != "undefined"){
                num ++;
            }
        }
        for(var item in checkVals){
            if(checkVals[item] != '' && typeof(checkVals[item]) != 'undefined'){
                var key = '';
                if(item == 'caseFounder'){
                    key = '接口创建人';
                }
                if(item == 'interfaceId'){
                    key = '接口编号';
                }
                if(item == 'title'){
                    key = '接口名称';
                }
                if(item == 'casedesc'){
                    key = '接口描述';
                }
                if(item == 'uri'){
                    key = '接口URI';
                }
                if(item == 'url'){
                    key = '接口URL';
                }
                if(item == "businessLine"){
                    key = '{{ groupLevel1 }}';
                }
                if(item == "module"){
                    key = '{{ groupLevel2 }}';
                }
                writeNum ++ ;
               {% comment %} if(writeNum != num){
                    htmls = htmls+'<a href="#" onclick="delCheckOptions(\''+item+'\')"  data-url="nav" data-key="ppath" style="font-size: 15px;text-decoration:none" >'+key+'：'+checkVals[item]+' <button class="btn btn-xs" style="background-color: #dddddd"><i style="color: #5e5e5e" class="icon-remove"></i> </button> </a><span style="font-size: 15px">-></span> '
                }else{
                    htmls = htmls+'<a href="#" onclick="delCheckOptions(\''+item+'\')" data-url="nav" data-key="ppath" style="font-size: 15px;text-decoration:none" >'+key+'：'+checkVals[item]+' <button class="btn btn-xs" style="background-color: #dddddd"><i style="color: #5e5e5e" class="icon-remove"></i> </button> </a> ';
                }{% endcomment %}
                htmls = htmls+'<span class="tag"><span>'+key+'：'+checkVals[item]+'&nbsp;&nbsp;</span><a href="javascript:void(0);" title="Removing tag" onclick="delCheckOptions(\''+item+'\')">x</a></span> '

            }
        }
        htmls = htmls +'<span class="tag" style="float: right;background-color: #ff7575"><span>默认筛选&nbsp;&nbsp;</span><a href="javascript:void(0);" title="Removing tag" onclick="clearChecked()">x</a></span>';

{#            htmls = htmls +'<a href="#" onclick="clearChecked()" style="font-size: 15px;text-decoration:none;float:right;">[默认筛选]</a>';#}
        $('#checkOption').html(htmls);
    }

    //排序样式显示
    function orderByShow() {
        if(addTimeFlag == '0'){
            $("#addTimeBtn").text('创建时间▼');
        }else if(addTimeFlag == '1'){
            $("#addTimeBtn").text('创建时间▲');
        }

        if(modTimeFlag == '0'){
            $("#modTimeBtn").text('修改时间▼');
        }else if(modTimeFlag == '1'){
            $("#modTimeBtn").text('修改时间▲');
        }
        if(interfaceNameFlag == '0'){
            $("#interfaceNameBtn").text('接口名称▼');
        }else if(interfaceNameFlag == '1'){
            $("#interfaceNameBtn").text('接口名称▲');
        }
    }

    function showSaveInterface() {
        $("#AllInterfaceTitle").hide();
        for(var i=0;i<interfaceList.length;i++){
            $("#saveInterfaceList").append('<tr name="interfaceTr"  onclick="trColor($(this))">\
                <td class="index" name="interfaceTRId" style="width: 10%"></td>\
                <td name="interfaceFlag">'+HTMLEncode(interfaceList[i])+'</td>\
                <td><textarea class="table-fixed-write" style="height:auto"  disabled>'+ HTMLEncode( interfaceData[interfaceList[i]].name)+'</textarea></td>\
                <td><textarea class="table-fixed-write" style="height:auto"  disabled>'+HTMLEncode(interfaceData[interfaceList[i]].casedesc)+'</textarea></td>\
                <td><textarea class="table-fixed-write" style="height:auto"  disabled>'+HTMLEncode(interfaceData[interfaceList[i]].url)+'</textarea></td>\
                <td>'+ interfaceData[interfaceList[i]].addBy+'</td>\
                <td>\
                <div style="margin-top: -10px">\
                <button class="btn btn-success optionButtionSize" style="margin-top:10px" value="'+interfaceList[i]+'" name="interfaceCopy" onclick="copyTr($(this))" title="拷贝"><i class="fa fa-copy"></i></button>\
                <a href="/interfaceTest/HTTP_operationInterface?option=check&interfaceId='+interfaceList[i]+'" target="_blank" ><button class="btn btn-info optionButtionSize" style="margin-top:10px" value="'+interfaceList[i]+'" name="interfaceCopy" title="查看"><i class="fa fa-info-circle"></i></button></a>\
               <button class="btn btn-danger optionButtionSize" style="margin-top:10px" value="'+interfaceList[i]+'" name="interfaceDel" onclick="delTr($(this))" title="删除"><i class="fa fa-trash"></i></button>\
               </div>\
               </td>\
                </tr>');
        }
        sortTable("interfaceTr");
        closeInterfaceList();

        interfaceList= [];
        $("#checkboxAll").prop("checked",false);
        $("#interfaceList").text("已选接口:");
        $("[name='interfaceCheckbox']").each(function () {
            if($(this).is(':checked')){
                interfaceList.splice($.inArray($(this).attr("id"),interfaceList),1);
                $(this).prop("checked",false);
            }
        });
        $("[href='#InterfacePage']").click();
    }

    function pageCall(pageNum) {
        interfacePage = pageNum;
        selected();
    }
    function inputVal(val) {
        $("#caseFounderInput").val(val);
        editCheckVal();
        interfaceListIsChecked();
    }
   function createPeople(num) {
        var htmlobj=$.ajax({url:'{% url 'queryPeopleInterfaceByTableName' %}?tbName=tb_http_interface&num='+num,async:false});
        var value = JSON.parse(htmlobj.responseText).body;
        var nameVal = "";
        for(var i = 0;i<value.length;i++){
            nameVal = nameVal + ' &nbsp <a href="javascript:void(0);" id="hover-a" onclick="inputVal(\''+value[i].userName+'\')"  style="font-size: 15px;text-decoration:none">['+value[i].userName+'('+value[i].count+')]</a>'
        }
        if(value.length<3){
            $("#names").html(nameVal);
            $("#hover-a").attr('onclick','createPeople('+(0)+')');
            $("#names").show();
            return;
        }else {
            $("#names").html(nameVal);
        }
        $("#hover-a").attr('onclick','createPeople('+(num+1)+')');
        $("#names").show();
    }
    function chechBtn(interfaceId) {
        if($("#"+interfaceId).is(':checked')){
            if(interfaceNum > (interfaceNumMax-1)){
                alert("任务最多只能包含"+interfaceNumMax+"个接口调用数量,当前"+interfaceNum);
                $("#"+interfaceId).prop("checked",false);
                return ;
            }
            interfaceNum ++;
            interfaceData[interfaceId] = {};
            interfaceData[interfaceId].name = $("#"+interfaceId).parent().next().next().text();
            interfaceData[interfaceId].casedesc =  $("#"+interfaceId).parent().next().next().next().text();
            interfaceData[interfaceId].url =  $("#"+interfaceId).parent().next().next().next().next().text();
            interfaceData[interfaceId].caseCheck =  $("#"+interfaceId).parent().next().next().next().next().next().next().children().html();
            interfaceData[interfaceId].addBy = $("#"+interfaceId).parent().next().next().next().next().next().text();
            interfaceList.push(interfaceId);
        }else {
            interfaceNum --;
            interfaceData[interfaceId] = {};
            interfaceList.splice($.inArray(interfaceId,interfaceList),1);
        }
        var allFlag = true;
        var interfaceCheckboxElements = $("[name='interfaceCheckbox']");
        interfaceCheckboxElements.each(function () {
            if(!$(this).prop("checked")){
                allFlag = false;
            }
        });
        if(allFlag){
            $("#checkboxAll").prop("checked",true);
        }else {
            $("#checkboxAll").prop("checked",false);
        }
        showInterfaceList();
    }
    function sortTable(name) {
        var tmpObj = $("[name='"+name+"']");
        tmpObj.each(function (i) {
            $(this).children("td.index").text(i+1);
        })
    }
    function showInterfaceList() {
        $("#interfaceList").text("已选接口:"+interfaceList.join(" ， "));
    }
    function Checkall() {
            var checkbox = $("[name='interfaceCheckbox']");
            if($("#checkboxAll").is(':checked')){
                checkbox.each(function () {
                    if(!$(this).is(':checked')){
                        if(interfaceNum > (interfaceNumMax-1)){
                            alert("任务最多只能包含"+interfaceNumMax+"个接口调用数量,当前"+interfaceNum);
                            return false;
                        }
                        interfaceNum ++;
                        interfaceData[$(this).attr("id")] = {};
                        interfaceData[$(this).attr("id")].name = $(this).parent().next().next().text();
                        interfaceData[$(this).attr("id")].casedesc = $(this).parent().next().next().next().text();
                        interfaceData[$(this).attr("id")].url = $(this).parent().next().next().next().next().text();
                        interfaceData[$(this).attr("id")].caseCheck = $(this).parent().next().next().next().next().next().next().children().html();
                        interfaceData[$(this).attr("id")].addBy = $(this).parent().next().next().next().next().next().text();

                        interfaceList.push($(this).attr("id"));
                        $(this).prop("checked",true);
                    }
                })
            }else {
                checkbox.each(function () {
                    if($(this).is(':checked')){
                        interfaceNum --;
                        interfaceData[$(this).attr("id")] = {};
                        interfaceList.splice($.inArray($(this).attr("id"),interfaceList),1);
                        $(this).prop("checked",false);
                    }
                });
            }
            showInterfaceList();
        }

    function delCheckOptions(key) {
            if(key=='caseFounder'){
                $("#caseFounderInput").val('all');
            }
            if(key=='interfaceId'){
                $("#interfaceIdInput").val('');
            }
            if(key=='title'){
                $("#caseNameInput").val('');
            }
            if(key=='casedesc'){
                $("#caseDescribeInput").val('');
            }
            if(key=='uri'){
                $("#uriInput").val('');
            }
            if(key=='url'){
                $("#caseInterFaceInput").val('');
            }
            if(key == "businessLine"){
                $("#caseBusinessLineCheckTab").click();
            }
            if(key == "module"){
                $("#caseModuleInput").val('');
            }
            editCheckVal();
        }
    function copyTr(mySelf){
            if(mySelf.attr("name") == "testCaseCopy") {
                var interfaceCount = mySelf.parent().parent().parent().find(".num").text();
                if (interfaceNum > (interfaceNumMax - interfaceCount)) {
                    alert("任务最多只能包含" + interfaceNumMax + "个接口调用数量,当前" + interfaceNum);
                    return;
                }
            }else {
                if (interfaceNum > (interfaceNumMax - 1)) {
                    alert("任务最多只能包含" + interfaceNumMax + "个接口调用数量,当前" + interfaceNum);
                    return;
                }
            }

            if(mySelf.attr("name") == "testCaseCopy"){
                interfaceNum += parseInt(mySelf.parent().parent().parent().find(".num").text());

            }else {
                interfaceNum ++;
            }

            var name = mySelf.parent().parent().parent().attr("name");
            mySelf.parent().parent().parent().after("<tr name='"+name+"' onclick=\"trColor($(this))\" >"+mySelf.parent().parent().parent().html()+"</tr>");
            sortTable(name);
        }
    function delTr(element) {

            if(element.attr("name") == "testCaseDel") {
                interfaceNum -= element.parent().parent().children(".num").text();
            }else {
                interfaceNum --;
            }

            element.parent().parent().parent().remove();

            if($("[name='interfaceFlag']").length == 0){
                $("#AllInterfaceTitle").show();
            }
            if ($("[name='testCaseFlag']").length == 0){
                $("#AllTestCaseTitle").show();
            }
            sortTable(element.parent().parent().parent().attr("name"))
        }
    function trColor(element) {
        if (element.css("background-color") === "rgb(245, 245, 245)") {
            element.css("background-color", "#b0e0e6")
        } else {
            element.removeAttr("style");
        }
    }
</script>

<!-- Content ends -->
{% include 'InterfaceTest/foot.html' %}